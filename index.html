<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω b·∫£n quy·ªÅn</title>
  <style>
    body {font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px;}
    h1 {text-align:center; margin-bottom:20px;}
    .form-container, .table-container {background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px;}
    .form-group {margin-bottom:15px;}
    label {display:block; margin-bottom:5px; font-weight:bold;}
    input {width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;}
    button {padding:10px 15px; background:#3498db; color:#fff; border:none; border-radius:4px; cursor:pointer;}
    button:hover {background:#2980b9;}
    table {width:100%; border-collapse:collapse; margin-top:10px;}
    th,td {border:1px solid #ddd; padding:10px; text-align:left;}
    th {background:#f2f2f2;}
    .key-used {background:#d4edda;}
    .key-unused {background:#fff3cd;}
    .copy-btn {
      padding: 5px 10px;
      margin-left: 10px;
      background: #5cb85c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .copy-btn:hover {
      background: #4cae4c;
    }
    .revoke-btn {
      padding: 5px 10px;
      margin-left: 5px;
      background: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .revoke-btn:hover {
      background: #c9302c;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>Qu·∫£n l√Ω m√£ b·∫£n quy·ªÅn</h1>
<div class="form-container">
  <h3>üìù T·∫°o m√£ b·∫£n quy·ªÅn m·ªõi</h3>
  <div class="form-group">
    <label for="keyCount">S·ªë l∆∞·ª£ng m√£</label>
    <input type="number" id="keyCount" value="5" min="1" max="1000">
  </div>
  <div class="form-group">
    <label for="keyLength">ƒê·ªô d√†i m√£ (6-20 k√Ω t·ª±)</label>
    <input type="number" id="keyLength" value="8" min="6" max="20">
  </div>
  <button id="generateBtn">T·∫°o m√£</button>
</div>
<div class="table-container">
  <h3>üìã Danh s√°ch m√£ b·∫£n quy·ªÅn</h3>
  <div id="keysTable"></div>
</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyB7qqxKGsD-enKgzeAvGQ8CwtTsFWy01OM",
  authDomain: "web-quan-ly.firebaseapp.com",
  databaseURL: "https://web-quan-ly-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "web-quan-ly",
  storageBucket: "web-quan-ly.firebasestorage.app",
  messagingSenderId: "623183081841",
  appId: "1:623183081841:web:72cee8d908d383b65e46d0"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// H√†m t·∫°o key ng·∫´u nhi√™n
function generateKey(len=8){
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let res = "";
  for(let i=0;i<len;i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
  return res;
}

// T·∫°o v√† l∆∞u key
async function createKeys(){
  const count = parseInt(document.getElementById('keyCount').value)||1;
  const length = parseInt(document.getElementById('keyLength').value)||8;
  const timestamp = new Date().toISOString();

  for(let i=0;i<count;i++){
    const key = generateKey(length);
    const data = { generatedAt: timestamp, used:false, usedAt:null };
    await database.ref('licenseKeys/'+key).set(data);
  }
  loadKeys();
}

document.getElementById('generateBtn').addEventListener('click', createKeys);

// H√†m sao ch√©p m√£ v√†o clipboard
function copyKeyToClipboard(key) {
  navigator.clipboard.writeText(key).then(() => {
    alert("ƒê√£ sao ch√©p: " + key);
  }).catch(err => {
    console.error('Kh√¥ng th·ªÉ sao ch√©p m√£: ', err);
  });
}

// H√†m hu·ª∑ b·∫£n quy·ªÅn
// H√†m hu·ª∑ b·∫£n quy·ªÅn
async function revokeLicense(key) {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën hu·ª∑ b·∫£n quy·ªÅn cho m√£: " + key + "?\n\nNg∆∞·ªùi d√πng s·∫Ω m·∫•t quy·ªÅn s·ª≠ d·ª•ng khi h·ªç ƒëƒÉng nh·∫≠p l·∫°i.")) {
    try {
      // 1. L·∫•y th√¥ng tin c·ªßa key ƒë·ªÉ x√°c ƒë·ªãnh ng∆∞·ªùi d√πng
      const licenseRef = database.ref('licenseKeys/' + key);
      const snapshot = await licenseRef.once('value');
      const licenseData = snapshot.val();

      if (licenseData && licenseData.usedBy) {
        // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i licensed: false cho ng∆∞·ªùi d√πng t∆∞∆°ng ·ª©ng
        const userRef = database.ref('users/' + licenseData.usedBy + '/license');
        await userRef.update({
          licensed: false,
          key: null, // X√≥a key kh·ªèi th√¥ng tin user
          activatedAt: null // X√≥a th·ªùi gian k√≠ch ho·∫°t
        });
        
        // 3. C·∫≠p nh·∫≠t stats n·∫øu c·∫ßn
        const statsRef = database.ref('stats');
        const statsSnapshot = await statsRef.once('value');
        const currentStats = statsSnapshot.val() || {};
        
        // Gi·∫£m s·ªë l∆∞·ª£ng licensed users n·∫øu c√≥
        if (currentStats.licensedUsersCount && currentStats.licensedUsersCount > 0) {
          await statsRef.update({
            licensedUsersCount: currentStats.licensedUsersCount - 1
          });
        }
      }

      // 4. C·∫≠p nh·∫≠t tr·∫°ng th√°i used: false cho key
      await licenseRef.update({
        used: false,
        usedAt: null,
        usedBy: null,
        usedByEmail: null
      });

      alert("ƒê√£ hu·ª∑ b·∫£n quy·ªÅn th√†nh c√¥ng cho m√£: " + key);
      loadKeys();
    } catch (error) {
      console.error("L·ªói khi hu·ª∑ b·∫£n quy·ªÅn:", error);
      alert("ƒê√£ x·∫£y ra l·ªói: " + error.message);
    }
  }
}

// Hi·ªÉn th·ªã key
function loadKeys(){
  database.ref('licenseKeys').on('value', snap => {
    if(!snap.exists()){ document.getElementById('keysTable').innerHTML = '<p>Ch∆∞a c√≥ m√£ n√†o.</p>'; return; }
    const keys = snap.val();
    let html = `<table><thead><tr><th>M√£</th><th>Tr·∫°ng th√°i</th><th>Ng√†y t·∫°o</th><th>Ng√†y c·∫•p</th><th>Ng∆∞·ªùi d√πng</th><th>Email</th><th>Thao t√°c</th></tr></thead><tbody>`;
    Object.entries(keys).forEach(([k,v])=>{
      html += `<tr class="${v.used?'key-used':'key-unused'}">
        <td><code>${k}</code> <button class="copy-btn" data-key="${k}">Sao ch√©p</button></td>
        <td>${v.used?'‚úÖ ƒê√£ c·∫•p':'üîÑ Ch∆∞a c·∫•p'}</td>
        <td>${v.generatedAt?new Date(v.generatedAt).toLocaleDateString('vi-VN'):'---'}</td>
        <td>${v.usedAt?new Date(v.usedAt).toLocaleDateString('vi-VN'):'---'}</td>
        <td>${v.usedBy||'---'}</td>
        <td>${v.usedByEmail||'---'}</td>
        <td>
          ${v.used ? `<button class="revoke-btn" data-key="${k}">Hu·ª∑ b·∫£n quy·ªÅn</button>` : '---'}
        </td>
      </tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('keysTable').innerHTML = html;

    // Th√™m event listener cho c√°c n√∫t sao ch√©p
    document.querySelectorAll('.copy-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const key = event.target.getAttribute('data-key');
        copyKeyToClipboard(key);
      });
    });
    
    // Th√™m event listener cho c√°c n√∫t hu·ª∑ b·∫£n quy·ªÅn
    document.querySelectorAll('.revoke-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const key = event.target.getAttribute('data-key');
        revokeLicense(key);
      });
    });
  });
}

loadKeys();
</script>
</body>
</html>
