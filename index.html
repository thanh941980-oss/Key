
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω b·∫£n quy·ªÅn</title>
  <style>
    body {font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:20px;}
    h1 {text-align:center; margin-bottom:20px;}
    .form-container, .table-container {background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-bottom:20px;}
    .form-group {margin-bottom:15px;}
    label {display:block; margin-bottom:5px; font-weight:bold;}
    input {width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;}
    button {padding:10px 15px; background:#3498db; color:#fff; border:none; border-radius:4px; cursor:pointer;}
    button:hover {background:#2980b9;}
    table {width:100%; border-collapse:collapse; margin-top:10px;}
    th,td {border:1px solid #ddd; padding:10px; text-align:left;}
    th {background:#f2f2f2;}
    .key-used {background:#d4edda;}
    .key-unused {background:#fff3cd;}
    .key-revoked {background:#f8d7da;}
    .copy-btn {
      padding: 5px 10px;
      margin-left: 10px;
      background: #5cb85c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .copy-btn:hover {
      background: #4cae4c;
    }
    .revoke-btn {
      padding: 5px 10px;
      margin-left: 5px;
      background: #d9534f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .revoke-btn:hover {
      background: #c9302c;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>Qu·∫£n l√Ω m√£ b·∫£n quy·ªÅn</h1>
<div class="form-container">
  <h3>üìù T·∫°o m√£ b·∫£n quy·ªÅn m·ªõi</h3>
  <div class="form-group">
    <label for="keyCount">S·ªë l∆∞·ª£ng m√£</label>
    <input type="number" id="keyCount" value="5" min="1" max="1000">
  </div>
  <div class="form-group">
    <label for="keyLength">ƒê·ªô d√†i m√£ (6-20 k√Ω t·ª±)</label>
    <input type="number" id="keyLength" value="8" min="6" max="20">
  </div>
  <button id="generateBtn">T·∫°o m√£</button>
</div>
<div class="table-container">
  <h3>üìã Danh s√°ch m√£ b·∫£n quy·ªÅn</h3>
  <div id="keysTable"></div>
</div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyB7qqxKGsD-enKgzeAvGQ8CwtTsFWy01OM",
  authDomain: "web-quan-ly.firebaseapp.com",
  databaseURL: "https://web-quan-ly-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "web-quan-ly",
  storageBucket: "web-quan-ly.firebasestorage.app",
  messagingSenderId: "623183081841",
  appId: "1:623183081841:web:72cee8d908d383b65e46d0"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// H√†m t·∫°o key ng·∫´u nhi√™n
function generateKey(len=8){
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let res = "";
  for(let i=0;i<len;i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
  return res;
}

// T·∫°o v√† l∆∞u key
async function createKeys(){
  const count = parseInt(document.getElementById('keyCount').value)||1;
  const length = parseInt(document.getElementById('keyLength').value)||8;
  const timestamp = new Date().toISOString();

  for(let i=0;i<count;i++){
    const key = generateKey(length);
    const data = { generatedAt: timestamp, used:false, usedAt:null };
    await database.ref('licenseKeys/'+key).set(data);
  }
  loadKeys();
}

document.getElementById('generateBtn').addEventListener('click', createKeys);

// H√†m sao ch√©p m√£ v√†o clipboard
function copyKeyToClipboard(key) {
  navigator.clipboard.writeText(key).then(() => {
    alert("ƒê√£ sao ch√©p: " + key);
  }).catch(err => {
    console.error('Kh√¥ng th·ªÉ sao ch√©p m√£: ', err);
  });
}

// H√†m hu·ª∑ b·∫£n quy·ªÅn
// H√†m hu·ª∑ b·∫£n quy·ªÅn
async function revokeLicense(key) {
  if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën hu·ª∑ b·∫£n quy·ªÅn cho m√£: " + key + "?\n\nNg∆∞·ªùi d√πng s·∫Ω m·∫•t quy·ªÅn s·ª≠ d·ª•ng khi h·ªç ƒëƒÉng nh·∫≠p l·∫°i.")) {
    try {
      // CH·ªà c·∫≠p nh·∫≠t licenseKeys, kh√¥ng ƒë·ªông ƒë·∫øn users
      await database.ref('licenseKeys/' + key).update({
        used: false,
        usedAt: null,
        usedBy: null,
        usedByEmail: null,
        revoked: true,
        revokedAt: new Date().toISOString()
      });

      alert("‚úÖ ƒê√£ hu·ª∑ b·∫£n quy·ªÅn th√†nh c√¥ng cho m√£: " + key + "\n\nL∆∞u √Ω: Ng∆∞·ªùi d√πng c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ h·ªá th·ªëng c·∫≠p nh·∫≠t tr·∫°ng th√°i.");
      loadKeys();
    } catch (error) {
      console.error("L·ªói khi hu·ª∑ b·∫£n quy·ªÅn:", error);
      alert("‚ùå ƒê√£ x·∫£y ra l·ªói: " + error.message);
    }
  }
}

      // 3. C·∫≠p nh·∫≠t tr·∫°ng th√°i used: false cho key
      await licenseRef.update({
        used: false,
        usedAt: null,
        usedBy: null,
        usedByEmail: null
      });

      alert("ƒê√£ hu·ª∑ b·∫£n quy·ªÅn th√†nh c√¥ng cho m√£: " + key);
      loadKeys();
    } catch (error) {
      console.error("L·ªói khi hu·ª∑ b·∫£n quy·ªÅn:", error);
      alert("ƒê√£ x·∫£y ra l·ªói: " + error.message);
    }
  }
}
// Hi·ªÉn th·ªã key
// Hi·ªÉn th·ªã key
function loadKeys(){
  console.log("loadKeys() ƒë∆∞·ª£c g·ªçi");
  
  database.ref('licenseKeys').on('value', snap => {
    console.log("Nh·∫≠n d·ªØ li·ªáu t·ª´ Firebase:", snap.exists());
    
    if(!snap.exists()){ 
      console.log("Kh√¥ng c√≥ d·ªØ li·ªáu");
      document.getElementById('keysTable').innerHTML = '<p>Ch∆∞a c√≥ m√£ n√†o.</p>'; 
      return; 
    }
    
    const keys = snap.val();
    console.log("D·ªØ li·ªáu keys:", keys);
    
    let html = `<table><thead><tr><th>M√£</th><th>Tr·∫°ng th√°i</th><th>Ng√†y t·∫°o</th><th>Ng√†y c·∫•p</th><th>Ng∆∞·ªùi d√πng</th><th>Email</th><th>Thao t√°c</th></tr></thead><tbody>`;
    
    Object.entries(keys).forEach(([k,v]) => {
      console.log("X·ª≠ l√Ω key:", k, v);
      
      // X√°c ƒë·ªãnh tr·∫°ng th√°i
      let status = 'üîÑ Ch∆∞a c·∫•p';
      let rowClass = 'key-unused';
      
      if (v.revoked) {
        status = '‚ùå ƒê√£ hu·ª∑';
        rowClass = 'key-revoked';
      } else if (v.used) {
        status = '‚úÖ ƒê√£ c·∫•p';
        rowClass = 'key-used';
      }
      
      html += `<tr class="${rowClass}">
        <td><code>${k}</code> <button class="copy-btn" data-key="${k}">Sao ch√©p</button></td>
        <td>${status}</td>
        <td>${v.generatedAt ? new Date(v.generatedAt).toLocaleDateString('vi-VN') : '---'}</td>
        <td>${v.usedAt ? new Date(v.usedAt).toLocaleDateString('vi-VN') : '---'}</td>
        <td>${v.usedBy || '---'}</td>
        <td>${v.usedByEmail || '---'}</td>
        <td>
          ${v.used && !v.revoked ? `<button class="revoke-btn" data-key="${k}">Hu·ª∑ b·∫£n quy·ªÅn</button>` : '---'}
        </td>
      </tr>`;
    });
    
    html += `</tbody></table>`;
    console.log("HTML generated:", html);
    
    document.getElementById('keysTable').innerHTML = html;
    console.log("ƒê√£ c·∫≠p nh·∫≠t b·∫£ng");

    // Th√™m event listener cho c√°c n√∫t sao ch√©p
    document.querySelectorAll('.copy-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const key = event.target.getAttribute('data-key');
        copyKeyToClipboard(key);
      });
    });
    
    // Th√™m event listener cho c√°c n√∫t hu·ª∑ b·∫£n quy·ªÅn
    document.querySelectorAll('.revoke-btn').forEach(button => {
      button.addEventListener('click', (event) => {
        const key = event.target.getAttribute('data-key');
        revokeLicense(key);
      });
    });
  }, error => {
    console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu:", error);
    document.getElementById('keysTable').innerHTML = '<p style="color:red">L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message + '</p>';
  });
}

loadKeys();
</script>
</body>
</html>
